---
title: SSH config ã‚’æ§‹é€ çš„ã«æ›¸ããŸã‚ã® Ruby ã® DSL Nymphia ã®ç´¹ä»‹
date: 2016-11-13
tags: infra, ruby
---

ãŸãã•ã‚“ã®ã‚µãƒ¼ãƒã‚’æ—¥ã€…æ‰±ã†ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã«ã¨ã£ã¦ã€SSH config ã‚’ã‚­ãƒ¬ã‚¤ã«ä¿ã¤ã“ã¨ã¯å¤§åˆ‡ã§ã™ã€‚
ãã‚‚ãã‚‚ SSH config ã¯æ§‹é€ çš„ã«æ›¸ãã«ãã„ä»•æ§˜ã«ãªã£ã¦ã„ã‚‹ã—ã€ã€Œã¾ã‚ãã‚“ãªã‚‚ã®ã‹..ã€ã¨å¦¥å”ã—ã¦ã€SSH config ã®ãƒ¡ãƒ³ãƒ†ãŒé©å½“ã«ãªã£ã¦ã—ã¾ã†ã“ã¨ã‚‚ã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚

ä»Šã¾ã§ã‚ãŸã—ã‚‚ãã†ã ã£ãŸã®ã§ã™ãŒã€ã•ã™ãŒã«ãã‚ãã‚ç ´æ»…ãŒè¦‹ãˆã¦ãã¦ã„ã¦ã€ãªã‚“ã¨ãªã Ruby ã§ DSL ã‚’ä½œã‚‹ã‚„ã£ã¦ã„ããŒé«˜ã¾ã£ãŸã®ã§ã€Ruby ã® DSL ã§è¨­å®šã‚’æ›¸ãã¨ SSH config ã‚’ç”Ÿæˆã™ã‚‹ [Nymphia](https://github.com/mozamimy/nymphia) ã¨ã„ã†ã‚‚ã®ã‚’ä½œã‚Šã¾ã—ãŸã€‚

[https://github.com/mozamimy/nymphia](https://github.com/mozamimy/nymphia)

ã¾ãŸã€è‰²ãŒã‚ã¾ã‚Šã¤ã‹ãªãã¦ã•ã¿ã—ã‹ã£ãŸã®ã§ã€[vim ã® syntax](https://github.com/mozamimy/nymphia.vim) ã‚‚ä½œã‚Šã¾ã—ãŸã€‚

[https://github.com/mozamimy/nymphia.vim](https://github.com/mozamimy/nymphia.vim)

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ä¾‹ã«ã‚ˆã£ã¦ Rubygems ã‹ã‚‰ã€‚

```
$ gem install nymphia
```

## ã“ã‚“ãªæ„Ÿã˜ã§ SSH config ãŒæ›¸ã‘ã¡ã‚ƒã†ã‚ˆ

### åŸºæœ¬å½¢

ã¾ãšã€ã„ã¡ã°ã‚“åŸºæœ¬çš„ãªã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

```ruby
identity_file :private, '~/.ssh/id_rsa.1'

my_server_port = 4321

host 'alice', 'my server on VPS' do
  hostname 'alice.example.com'
  user 'alice'
  port my_server_port
  use_identify_file :private
end
```

ã“ã‚Œã‚’ãƒˆãƒ©ãƒ³ã‚¹ãƒ¬ãƒ¼ã‚¿ã«ã‹ã‘ã‚‹ã¨ã€

```
#
# This config is generated by Nymphia 0.1.0
#

# my server on VPS
Host alice
  Hostname alice.example.com
  User alice
  Port 4321
  IdentityFile ~/.ssh/id_rsa.1
```

ã“ã‚“ãªæ„Ÿã˜ã® SSH config ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚ãƒˆãƒ©ãƒ³ã‚¹ãƒ¬ãƒ¼ãƒˆã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã„ã¾ã™ã€‚

```
$ nymphia -f /path/to/nymphia_file.rb -o /path/to/output_file
```

ãƒ›ã‚¹ãƒˆã®å®šç¾©ã¯ `host` ãƒ¡ã‚½ãƒƒãƒ‰ã§è¡Œã„ã¾ã™ã€‚ç¬¬ä¸€å¼•æ•°ã«ãƒ›ã‚¹ãƒˆåã€ç¬¬äºŒå¼•æ•°ã«èª¬æ˜ã‚’æ›¸ãã¾ã™ã€‚ç¬¬äºŒå¼•æ•°ã¯çœç•¥å¯èƒ½ã§ã€æ›¸ã„ãŸå ´åˆã¯ç”Ÿæˆå¾Œã® `Host` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã®ä¸Šã«æ·»ãˆã‚‰ã‚Œã¾ã™ã€‚

åŸºæœ¬çš„ã« Ruby ãªã®ã§ã€`my_server_port` ã®ã‚ˆã†ã«å¤‰æ•°ã‚’å®šç¾©ã—ã¦ä½¿ã†ã¨ã„ã£ãŸã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

ã¾ãŸã€SSH config ã®ä¸æº€ç‚¹ã®ã²ã¨ã¤ã«ã€ã‚ã‚‰ã‚†ã‚‹å ´æ‰€ã« IdentityFile ã«è¨­å®šã™ã‚‹åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æ›¸ã‹ãªã„ã¨ã„ã‘ãªã„ã¨ã„ã†ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®å•é¡Œã¯ `identity_file` ã¨ `use_identify_file` ã§è§£æ±ºã—ã¦ã„ã¦ã€`identity_file` ã« `:private` ã®ã‚ˆã†ãªåå‰ã‚’ã¤ã‘ã¦ã€`host` ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸­ã§ `use_identify_file` ã®ã‚ˆã†ã«æ›¸ãã¨ã„ã„æ„Ÿã˜ã« `IdentityFile` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’åŸ‹ã‚è¾¼ã‚“ã§ãã‚Œã¾ã™ã€‚
ã¾ãŸã€`use_identify_file :usausa, :pyonpyon` ã®ã‚ˆã†ã«ã€è¤‡æ•°æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

### ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²

`load` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ãˆã°ã€ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²ã‚’ã—ã¦è¨­å®šã‚’ç®¡ç†ã§ãã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã¨ã€ãƒˆãƒ©ãƒ³ã‚¹ãƒ¬ãƒ¼ã‚¿æ™‚ã« other\_nymphia\_file.rb ã‚’èª­ã¿è¾¼ã‚“ã§å®Ÿè¡Œã—ã¾ã™ã€‚

```ruby

identity_file :private, '~/.ssh/id_rsa.1'

host 'alice', 'my server on VPS' do
  hostname 'alice.example.com'
  user 'alice'
  port 4321
  use_identify_file :private
end

load 'other_nymphia_file.rb'
```

### Proxy ã‚’å®šç¾©ã™ã‚‹

ç´ ã® SSH config ã§ã¯ã€ãƒ›ã‚¹ãƒˆã®å®šç¾©ã¯ã™ã¹ã¦ `Host` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã§å®šç¾©ã™ã‚‹ã®ã§ã€ãã®ãƒ›ã‚¹ãƒˆãŒãƒ—ãƒ­ã‚¯ã‚·ã¨ã—ã¦ä½¿ã‚ã‚Œã‚‹ã®ã‹ã€é€šå¸¸ã®æ¥ç¶šå…ˆã¨ã—ã¦ä½¿ã‚ã‚Œã‚‹ã®ã‹ã€ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã¨ã—ã¦è¸ã¿å°ã«ã™ã‚‹ã®ã‹ã€ã‚³ãƒ¼ãƒ‰ã ã‘ã§ã¯ã‚ã‹ã‚Šã«ãã„ã®ã‚‚ä¸æº€ã§ã—ãŸã€‚

ãã“ã§ã€Nymphia ã§ã¯ã€`proxy` ã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†ã“ã¨ã§ã€æ˜ç¤ºçš„ã«ãã®æ¥ç¶šå…ˆãŒãƒ—ãƒ­ã‚¯ã‚·ã¨ã—ã¦ä½¿ã‚ã‚Œã‚‹ã“ã¨ã‚’ã‚³ãƒ¼ãƒ‰ã§ç¤ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚ã¾ãŸã€`proxy` ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä¸­ã§ã¯ã€`local_forward` ãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚ˆãã‚ã‚‹ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®è¨­å®šã‚’èª­ã¿ã‚„ã™ãæ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

ä»¥ä¸‹ã¯ `proxy` ã‚’ä½¿ã£ãŸä¾‹ã§ã™ã€‚

```ruby
identity_file :company_gateway, '~/.ssh/id_rsa.company.gw'

proxy 'awsproxy.company.apne1' do
  hostname 'gw.apne1.example.com'
  user 'alice'
  port 19822
  use_identify_file :company_gateway

  # SOCKS proxy
  dynamic_forward 23921

  # ssh tunnels
  local_forward 'mysql-server', {
    'localhost' => 13306,
    'mysql.apne.aws.example.com' => 3306,
  }

  local_forward 'ldap', {
    'localhost' => 10389,
    'ldap.apne.aws.example.com' => 398,
  }
end
```

ã“ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ Nymphia ã«ã‹ã‘ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå‡ºåŠ›ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚

```
#
# This config is generated by Nymphia 0.1.0
#

Host awsproxy.company.apne1
  Hostname gw.apne1.example.com
  User alice
  Port 19822
  IdentityFile ~/.ssh/id_rsa.company.gw
  DynamicForward 23921
  LocalForward localhost:13306 mysql.apne.aws.example.com:3306
  LocalForward localhost:10389 ldap.apne.aws.example.com:398
```

### å¿œç”¨ç·¨: ãƒ›ã‚¹ãƒˆã‚’ã‚°ãƒ«ãƒ¼ãƒ—ã«ã¾ã¨ã‚ã‚‹ã€groupã€use\_gatewayã€default\_params

æ§‹é€ åŒ–ã®ãŸã‚ã®å¼·åŠ›ãªæ©Ÿæ§‹ã¨ã—ã¦ã€Nymphia ã¯ `group`ã€`gateway`ã€`use_gateway`ã€`default_params` ã¨ã„ã£ãŸãƒ¡ã‚½ãƒƒãƒ‰ã‚’æä¾›ã—ã¾ã™ã€‚

ä»¥ä¸‹ã«ãã‚Œã‚‰ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ãŸä¾‹ã‚’ç¤ºã—ã¾ã™ã€‚

```ruby

identity_file :company, '~/.ssh/id_rsa.company'
identity_file :company_gateway, '~/.ssh/id_rsa.company.gw'

gateway 'company.gateway' do
  hostname 'gw.example.com'
  user 'alice'
  port 19822
end

group 'company.ap-northeast-1' do
  use_gateway 'company.gateway'

  default_params do
    check_host_ip 'no'
    strict_host_key_checking 'no'
    user 'alice'
    port 9822
    use_identify_file :company, :company_gateway
  end

  host '*.apne.aws.example.com'

  host 'alice.apne.aws.example.com' do
    hostname '10.16.16.16'
    user 'white_rabbit'
    port 7777
  end
end
```

ã“ã®ä¾‹ã‚’ãƒˆãƒ©ãƒ³ã‚¹ãƒ¬ãƒ¼ãƒˆã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå‡ºåŠ›ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚

```
#
# This config is generated by Nymphia 0.1.0
#

Host company.gateway
  Hostname gw.example.com
  User alice
  Port 19822

Host *.apne.aws.example.com
  CheckHostIp no
  StrictHostKeyChecking no
  User alice
  Port 9822
  IdentityFile ~/.ssh/id_rsa.company
  IdentityFile ~/.ssh/id_rsa.company.gw
  ProxyCommand ssh company.gateway -q -W %h:%p

Host alice.apne.aws.example.com
  CheckHostIp no
  StrictHostKeyChecking no
  IdentityFile ~/.ssh/id_rsa.company
  IdentityFile ~/.ssh/id_rsa.company.gw
  ProxyCommand ssh company.gateway -q -W %h:%p
  Hostname 10.16.16.16
  User white_rabbit
  Port 7777
```

`gateway` ãƒ¡ã‚½ãƒƒãƒ‰ã‚‚ `proxy` ãƒ¡ã‚½ãƒƒãƒ‰ã¨ä¼¼ã¦ã„ã¦ã€`host` ã¨ã»ã¼ãŠãªã˜ã¯ãŸã‚‰ãã‚’ã—ã¾ã™ã€‚
ãŸã ã—ã€`gateway` ã¨ã—ã¦ç™»éŒ²ã•ã‚ŒãŸãƒ›ã‚¹ãƒˆã¯ã€`group` ãƒ¡ã‚½ãƒƒãƒ‰ã«ã‚ˆã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã®ä¸­ã§ `use_gateway` ã§æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ã‚°ãƒ«ãƒ¼ãƒ—ã«å«ã¾ã‚Œã‚‹ãƒ›ã‚¹ãƒˆã®ä¸­ã§ `ProxyCommand ssh company.gateway -q -W %h:%p` ã®ã‚ˆã†ãª `ProxyCommand` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’ã„ã„æ„Ÿã˜ã«ç”Ÿæˆã—ã¦ãã‚Œã¾ã™ã€‚

ã¾ãŸã€`default_params` ã‚’ä½¿ã†ã¨ã€ã‚°ãƒ«ãƒ¼ãƒ—ä¸­ã®ãƒ›ã‚¹ãƒˆã«å¯¾ã™ã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
`host '*.apne.aws.example.com'` ã§ä½•ã‚‚æ›¸ã„ã¦ã„ãªã„ã®ã«ã€ç¨®ã€…ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã®ãŒã‚ã‹ã‚‹ã¨æ€ã„ã¾ã™ã€‚

ã¾ãŸã€`host 'alice.apne.aws.example.com'` ã®ä¾‹ã®ã‚ˆã†ã«ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

[GitHub ä¸Šã® examples](https://github.com/mozamimy/nymphia/tree/master/examples) ã‚’è¦‹ã‚‹ã¨ã€ä»¥ä¸Šã®æ©Ÿæ§‹ã‚’ã™ã¹ã¦ä½¿ã£ãŸä¾‹ãŒã‚ã‚‹ã®ã§ã€Nymphia ã‚’ä½¿ã†éš›ã«å‚è€ƒã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

## Vim ã® syntax ã‚‚ã‚ã‚‹ã‚ˆ

Ruby ã§æ°—æŒã¡ã‚ˆãæ›¸ã‘ã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã¯ã„ã„ã®ã§ã™ãŒã€ç¨®ã€…ã®æ©Ÿèƒ½ã¯ãƒ¡ã‚½ãƒƒãƒ‰ã¨ã—ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€[vim ã®ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹å®šç¾©](https://github.com/mozamimy/nymphia.vim) ã‚’ä½œã£ã¦ã«ãã‚„ã‹ã«æ›¸ã‘ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚
[nymphia.vim](https://github.com/mozamimy/nymphia.vim) ã‚’å…¥ã‚Œã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã«ãã‚„ã‹ã« Nymphia ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã§ãã¾ã™ã€‚

<img alt='nymphia.vim 'src='/2016/11/13/release_nymphia/nymphia.vim.png' style='width: 600px;'>

vim ã® syntax å®šç¾©ã‚’ä½œã‚‹ã®ãŒåˆã‚ã¦ã§ã€ãƒãƒãƒ£ãƒ¡ãƒãƒ£ã ã£ãŸã®ã‚’ [@Linda_pp](https://twitter.com/Linda_pp) ã•ã‚“ãŒæ·»å‰Šã—ã¦ãã‚Œã¾ã—ãŸ ğŸ¶ ğŸ°
vim ã®ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã¯éå¸¸ã«è¦ªåˆ‡ãªã®ã§ã¡ã‚ƒã‚“ã¨èª­ã¾ã­ã°..

## Nymphia is ä½•

[ã‹ã‚ã„ã„](https://www.google.co.jp/search?q=%E3%83%8B%E3%83%B3%E3%83%95%E3%82%A3%E3%82%A2&source=lnms&tbm=isch&sa=X&ved=0ahUKEwjUv6no16XQAhWCi7wKHT1dC5UQ_AUICCgB&biw=1150&bih=789)
